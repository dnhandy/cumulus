<html>
  <head>
    <title>Cumulus</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.15/datatables.min.css"/>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.15/datatables.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Cumulus</a>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container" style="margin-top:80px">
      <div class="row">
        <div class="col-md-3" style="overflow:auto; border-right:1px solid grey">
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#submit-job-modal">
            New Job
          </button>
          <h2>Job History</h2>
          <table id="job-list" class="table">
            <thead>
              <tr>
                <th>Job ID</th>
                <th>Status</th>
                <th>Last status change</th>
              </tr>
            </thead>
            <tbody>

            </tbody>
          </table>
        </div>
        <div clas="col-md-9" style="overflow:auto; padding: 10px; background-color:lightgrey;min-height:600px;border-left:1px solid grey">
          <div id="details-div" style="display:none;padding:10px;margin:10px;background-color:white">
            <div id="details-header">

            </div>
            <ul class="nav nav-tabs">
              <li><a id="details-tab" data-toggle="tab" href="#details">Details</a></li>
              <li><a id="visualization-tab" data-toggle="tab" href="#visualization">Visualization</a></li>
              <li><a id="results-tab" data-toggle="tab" href="#results">Results</a></li>
              <li><a id="log-tab" data-toggle="tab" href="#log">Log</a></li>
            </ul>

            <div class="tab-content">
              <div id="details" class="tab-pane fade">
                <table class="table-bordered table">
                  <tr>
                    <td><strong>Name:</strong></td><td><span id="job-name"></span></td>
                  </tr>
                  <tr>
                    <td><strong>Status:</strong></td><td><span id="job-status"></span></td>
                  </tr>
                  <tr>
                    <td><strong>Submitted at:</strong></td><td><span id="submit-date"></span></td>
                  </tr>
                  <tr>
                    <td><strong>Last Change:</strong></td><td><span id="change-date"></span></td>
                  </tr>
                  <tr>
                    <td><strong>Executable:</strong></td>
                    <td><a id="executable-link"></a></td>
                  </tr>
                  <tr>
                    <td><strong>Inputs:</strong></td>
                    <td><ul id='input-list'></ul></td>
                  </tr>
                  <tr>
                    <td><strong>Generated Artifacts:</strong></td>
                    <td><ul id='output-list'></ul></td>
                  </tr>
                </table>
              </div>
              <div id="visualization" class="tab-pane fade"></div>
              <div id="results" class="tab-pane fade"></div>
              <div id="log" class="tab-pane fade"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!--<div class="modal fade" id="submit-job-modal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Submit cyclus job</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="radio">
                <label><input type="radio" name="input-file-type" value="standard" /> Use existing input file</label>
              </div>
              <div class="radio">
                <label><input type="radio" name="input-file-type" value="custom" /> Upload new input file</label>
              </div>
              <hr />
              <div id="standard">
                <div class="form-group">
                  <label for="fileID">Input File:</label>
                  <select name="file-id" class="form-control">
                    <optgroup id="cycamore-opt-group" label="Cycamore Input Files">
                    </optgroup>
                    <optgroup id="custom-opt-group" label="Custom Input Files">
                    </optgroup>
                  </select>
                </div>
              </div>
              <div id="custom">
                <div class="form-group">
                  <label for="file-upload">Input File:</label>
                  <input class="form-control" type="file" name="upload" />
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" name="permanent" /> Add file to list for re-use in future jobs</label>
                </div>
              </div>
              <div id="error" style="color:red"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" id="submit-job-button" class="btn btn-primary">Save changes</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>-->

    <script type="text/javascript">

      status_icons = {
        canceled: "images/canceled_icon.png",
        cancelling: "images/cancelling_icon.png",
        failed: "images/failed_icon.png",
        finished: "images/finished_icon.png",
        paused: "images/paused_icon.png",
        pausing: "images/paused_icon.png",
        pending: "images/pending_icon.png",
        running: "images/running_icon.png"
      };

      function submitJob(inputFileID)
      {
        $.ajax({
          url: 'api/jobs',
          type: 'POST',
          dataType: "json",
          contentType: "application/json; charset=utf-8",
          data: JSON.stringify({ input_file_id: inputFileID }),
          success: function() {
            window.location.reload();
          },
          error: function(){
            $('#error').empty().append("Failed to submit job. An unknown error occured");
          }
        });
      }

      function validate()
      {
        return true;
      }

      function makeFileLink(fileID, link)
      {
        $.ajax({
          url: 'api/job_files/' + fileID,
          success: function(response)
          {
            $(link).attr('href', 'api/job_files/' + fileID + '/download');
            $(link).empty().append(response.data.attributes.name);
            $(link).prop('download', true);
          }
        });
      }

      function makeCap(string) {
          return string.charAt(0).toUpperCase() + string.slice(1);
      }

      function sortByID(a, b) {
        var aID = parseInt(a.id);
        var bID = parseInt(b.id);

        if (aID < bID)
        {
          return -1;
        }
        if (aID > bID)
        {
          return 1;
        }
        return 0;
      }

      function sortByIDDesc(a, b)
      {
        return sortByID(b, a);
      }

      function jobDetails(jobID)
      {
        $.ajax({
          url: 'api/jobs/' + jobID,
          success: function(response){
            $("#details-div").show();

            status = response.data.attributes.status
            $("#details-header").empty().append(
              '<h2>' + response.data.attributes.name + '</h2>' +
              '<h3><img height="32" width="32" src="' +
              status_icons[status] +'" alt="' + makeCap(status) + '" title="' + makeCap(status) + '" />&nbsp;' +
              makeCap(status) + '</h3>'
            );

            $('#job-name').empty().append(response.data.attributes.name);
            $('#job-status').empty().append(makeCap(status));
            //TODO: submit date
            //TODO: change date

            $('#executable-link').empty();
            $('#input-list').empty();
            $('#output-list').empty();

            $('#executable-link').attr('href', '#');
            if (response.data.relationships)
            {
              if (response.data.relationships.executable &&
                response.data.relationships.executable.data)
              {
                makeFileLink(response.data.relationships.executable.data.id, $('#executable-link'));
              }

              var inputs = response.data.relationships.inputs
              if (inputs && inputs.data)
              {
                inputs.data.forEach(function(input){
                  var link = $('<a></a>');
                  makeFileLink(input.id, link);
                  var item = $('<li></li>');
                  $(item).append(link)
                  $('#input-list').append(item);
                })
              }

              var outputs = response.data.relationships.outputs
              if (outputs && inputs.data)
              {
                outputs.data.forEach(function(output){
                  var link = $('<a></a>');
                  makeFileLink(output.id, link);
                  var item = $('<li></li>');
                  $(item).append(link)
                  $('#output-list').append(item);
                })
              }
            }

            var doVisualization = false;
            //TODO: Visualization stuff

            if (doVisualization)
            {
              $("#visualization-tab").show();
            }
            else {
              $("#visualization-tab").hide();
            }

            $("#details-tab").click();

            $('#visualization').empty();
            $('#results').empty();
            $('#log').empty();

            $.ajax({
              url: 'api/jobs/' + jobID + '/results',
              success: function(response){
                var results = response.data.sort(sortByID);

                results.forEach(function (result){
                  $('#results').append('<p>' + result.attributes.contents + '</p>');
                });
              }
            });

            $.ajax({
              url: 'api/jobs/' + jobID + '/logs',
              success: function(response){
                var logs = response.data.sort(sortByID);

                logs.forEach(function (log){
                  $('#log').append('<p>[' + log.attributes.application + '] ' + log.attributes.contents + '</p>');
                });
              }
            });
          },
          error: function(xhr){
            alert('Unable to load job #' + jobID);
          }
        });
      }

      function getJobs()
      {
        $.ajax({
          url: "api/jobs",
          success: function(response) {
            $("#job-list tbody").empty();

            var jobs = response.data.sort(sortByIDDesc);

            jobs.forEach(function(job){
              var id = job.id
              var status = job.attributes.status
              var name = job.attributes.name

              $("#job-list tbody").append($(
                '<tr><td><img height="16" width="16" src="' +
                status_icons[status] +'" alt="' + makeCap(status) + '" title="' + makeCap(status) + '" />' +
                '</a></td><td><strong>' + id +
                '</td><td><a href="javascript:void(0)" onclick="jobDetails(' + id + ')">' + name +
                '</a></td></tr>'
              ));
            });
          }
        });
      }

      $(document).ready(function(){
        //Populate job history
        setInterval(function(){
          getJobs();
        }, 2000);

      });
    </script>
  </body>
</html>
